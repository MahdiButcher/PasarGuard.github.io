---
title: مرجع API
description: مرجع کامل REST API و gRPC برای نود PasarGuard
icon: Code
---

## بررسی اجمالی API

نود PasarGuard هم رابط **REST API** و هم **gRPC** را برای مدیریت نود، کاربران و بازیابی آمار فراهم می‌کند.

### احراز هویت

تمام درخواست‌های API نیاز به احراز هویت با استفاده از `SESSION_ID` پیکربندی شده در فایل `.env` شما دارند.

**REST API:**
```http
Authorization: Bearer <session_id>
```

**gRPC:**
```
authorization: Bearer <session_id>
```

### URL پایه

درخواست‌های REST API باید به این آدرس ارسال شوند:
```
https://your-node-address:port/
```

### نوع محتوا

REST API از Protocol Buffers برای سریال‌سازی داده استفاده می‌کند:
```http
Content-Type: application/x-protobuf
```

---

## ساختارهای داده

### Backend

```protobuf
message Backend {
  BackendType type;      // نوع بکند (XRAY = 0)
  string config;         // پیکربندی بکند
  repeated User users;   // لیست کاربران
  uint64 keepAlive;      // مدت زمان keep alive به ثانیه
}
```

### User

```protobuf
message User {
  string email;           // شناسه یکتای ایمیل کاربر
  Proxy proxies;          // پیکربندی‌های پروکسی
  repeated string inbounds; // لیست تگ‌های ورودی
}
```

### StatRequest

```protobuf
message StatRequest {
  string name;      // ایمیل کاربر یا تگ ورودی/خروجی
  bool reset;       // بازنشانی آمار ترافیک پس از بازیابی
  StatType type;    // نوع آمار برای بازیابی
}

enum StatType {
  Outbounds = 0;   // تمام آمار خروجی
  Outbound = 1;    // آمار خروجی تکی
  Inbounds = 2;    // تمام آمار ورودی
  Inbound = 3;     // آمار ورودی تکی
  UsersStat = 4;   // تمام آمار کاربران
  UserStat = 5;    // آمار کاربر تکی
}
```

---

## متدهای API

### مدیریت نود

#### شروع بکند

شروع بکند نود با پیکربندی.

<Tabs items={['REST', 'gRPC', 'cURL']}>
  <Tab value="REST">
    ```http
    POST /start
    Authorization: Bearer <session_id>
    Content-Type: application/x-protobuf

    Body: Backend (protobuf)
    ```
  </Tab>
  <Tab value="gRPC">
    ```
    rpc Start(Backend) returns (BaseInfoResponse)
    ```
  </Tab>
  <Tab value="cURL">
    ```bash
    curl -X POST https://node:443/start \
      -H "Authorization: Bearer your-session-id" \
      -H "Content-Type: application/x-protobuf" \
      --data-binary @backend.pb
    ```
  </Tab>
</Tabs>

<Callout type="info">
  این تنها متدی است که قبل از ایجاد اتصال با نود فراخوانی می‌شود.
</Callout>

---

#### توقف بکند

توقف بکند و غیرفعال کردن اتصالات کلاینت.

<Tabs items={['REST', 'gRPC', 'cURL']}>
  <Tab value="REST">
    ```http
    PUT /stop
    Authorization: Bearer <session_id>
    ```
  </Tab>
  <Tab value="gRPC">
    ```
    rpc Stop(Empty) returns (Empty)
    ```
  </Tab>
  <Tab value="cURL">
    ```bash
    curl -X PUT https://node:443/stop \
      -H "Authorization: Bearer your-session-id"
    ```
  </Tab>
</Tabs>

---

#### دریافت اطلاعات پایه

بازیابی اطلاعات پایه نود و بررسی وضعیت اتصال.

<Tabs items={['REST', 'gRPC', 'cURL']}>
  <Tab value="REST">
    ```http
    GET /info
    Authorization: Bearer <session_id>
    ```
  </Tab>
  <Tab value="gRPC">
    ```
    rpc GetBaseInfo(Empty) returns (BaseInfoResponse)
    ```
  </Tab>
  <Tab value="cURL">
    ```bash
    curl https://node:443/info \
      -H "Authorization: Bearer your-session-id"
    ```
  </Tab>
</Tabs>

**پاسخ:**
```protobuf
message BaseInfoResponse {
  string version;
  string core_type;
  bool running;
}
```

---

### لاگ‌گیری

#### دریافت لاگ‌ها

پخش لاگ‌های زمان واقعی از بکند.

<Tabs items={['REST', 'gRPC', 'cURL']}>
  <Tab value="REST">
    ```http
    GET /logs
    Authorization: Bearer <session_id>
    
    // بازگرداندن جریان Server-Sent Events (SSE)
    ```
  </Tab>
  <Tab value="gRPC">
    ```
    rpc GetLogs(Empty) returns (stream Log)
    ```
  </Tab>
  <Tab value="cURL">
    ```bash
    curl -N https://node:443/logs \
      -H "Authorization: Bearer your-session-id"
    ```
  </Tab>
</Tabs>

**ساختار لاگ:**
```protobuf
message Log {
  string detail;  // پیام لاگ
}
```

---

### آمار

#### دریافت آمار سیستم

بازیابی آمار سطح سیستم.

<Tabs items={['REST', 'gRPC', 'cURL']}>
  <Tab value="REST">
    ```http
    GET /stats/system
    Authorization: Bearer <session_id>
    ```
  </Tab>
  <Tab value="gRPC">
    ```
    rpc GetSystemStats(Empty) returns (SystemStatsResponse)
    ```
  </Tab>
  <Tab value="cURL">
    ```bash
    curl https://node:443/stats/system \
      -H "Authorization: Bearer your-session-id"
    ```
  </Tab>
</Tabs>

**پاسخ:**
```protobuf
message SystemStatsResponse {
  uint64 mem_total;                  // کل حافظه
  uint64 mem_used;                   // حافظه استفاده شده
  uint64 cpu_cores;                  // هسته‌های CPU
  double cpu_usage;                  // استفاده از CPU %
  uint64 incoming_bandwidth_speed;   // سرعت دانلود
  uint64 outgoing_bandwidth_speed;   // سرعت آپلود
}
```

---

#### دریافت آمار بکند

بازیابی آمار زمان اجرای بکند.

<Tabs items={['REST', 'gRPC', 'cURL']}>
  <Tab value="REST">
    ```http
    GET /stats/backend
    Authorization: Bearer <session_id>
    ```
  </Tab>
  <Tab value="gRPC">
    ```
    rpc GetBackendStats(Empty) returns (BackendStatsResponse)
    ```
  </Tab>
  <Tab value="cURL">
    ```bash
    curl https://node:443/stats/backend \
      -H "Authorization: Bearer your-session-id"
    ```
  </Tab>
</Tabs>

**پاسخ:**
```protobuf
message BackendStatsResponse {
  uint32 num_goroutine;    // گوروتین‌های فعال
  uint32 num_gc;           // اجراهای GC
  uint64 alloc;            // حافظه اختصاص داده شده
  uint64 total_alloc;      // کل اختصاص داده شده
  uint64 sys;              // حافظه سیستم
  uint64 mallocs;          // تعداد Malloc
  uint64 frees;            // تعداد Free
  uint64 live_objects;     // اشیاء زنده
  uint64 pause_total_ns;   // کل توقف GC
  uint32 uptime;           // زمان فعالیت به ثانیه
}
```

---

#### دریافت آمار ترافیک

بازیابی آمار ترافیک برای کاربران، ورودی‌ها یا خروجی‌ها.

<Tabs items={['REST', 'gRPC', 'cURL']}>
  <Tab value="REST">
    ```http
    GET /stats
    Authorization: Bearer <session_id>
    Content-Type: application/x-protobuf

    Body: StatRequest (protobuf)
    ```
  </Tab>
  <Tab value="gRPC">
    ```
    rpc GetStats(StatRequest) returns (StatResponse)
    ```
  </Tab>
  <Tab value="cURL">
    ```bash
    curl -X GET https://node:443/stats \
      -H "Authorization: Bearer your-session-id" \
      -H "Content-Type: application/x-protobuf" \
      --data-binary @stat-request.pb
    ```
  </Tab>
</Tabs>

**مثال‌ها:**

دریافت آمار تمام کاربران:
```protobuf
StatRequest {
  type: UsersStat,
  reset: false
}
```

دریافت آمار کاربر خاص:
```protobuf
StatRequest {
  name: "user@example.com",
  type: UserStat,
  reset: true  // بازنشانی پس از بازیابی
}
```

**پاسخ:**
```protobuf
message StatResponse {
  repeated Stat stats;
}

message Stat {
  string name;   // ایمیل کاربر یا تگ
  string type;   // نوع آمار
  string link;   // شناسه لینک
  int64 value;   // مقدار ترافیک به بایت
}
```

---

### مدیریت کاربران

#### همگام‌سازی کاربر

اضافه کردن، به‌روزرسانی یا حذف یک کاربر.

<Tabs items={['REST', 'gRPC', 'cURL']}>
  <Tab value="REST">
    ```http
    PUT /user/sync
    Authorization: Bearer <session_id>
    Content-Type: application/x-protobuf

    Body: User (protobuf)
    ```
  </Tab>
  <Tab value="gRPC">
    ```
    rpc SyncUser(stream User) returns (Empty)
    ```
  </Tab>
  <Tab value="cURL">
    ```bash
    curl -X PUT https://node:443/user/sync \
      -H "Authorization: Bearer your-session-id" \
      -H "Content-Type: application/x-protobuf" \
      --data-binary @user.pb
    ```
  </Tab>
</Tabs>

<Callout type="info">
  برای **حذف** کاربر، آرایه ورودی‌های خالی ارسال کنید. gRPC یک رابط جریانی فراهم می‌کند، اما REST نیاز به فراخوانی‌های جداگانه برای هر کاربر دارد.
</Callout>

---

## پاسخ‌های خطا

### کدهای وضعیت HTTP

| کد | معنی |
|------|---------|
| 200 | موفقیت |
| 400 | درخواست بد - داده نامعتبر |
| 401 | غیرمجاز - SESSION_ID نامعتبر |
| 404 | یافت نشد - نقطه پایانی وجود ندارد |
| 500 | خطای داخلی سرور |

---

## محدودیت نرخ

در حال حاضر محدودیت نرخ داخلی وجود ندارد، اما توصیه می‌شود:
- در صورت امکان به‌روزرسانی‌های کاربر را دسته‌بندی کنید
- آمار را به صورت محلی کش کنید
- از نظرسنجی بیش از حد اجتناب کنید

