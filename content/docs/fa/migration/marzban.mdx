---
title: مرزبان به پاسارگارد
icon: ArrowRightLeft
---

<Alert type="warning">
این راهنما برای نسخه‌های `beta-3` و پایین‌تر مرزبان هست.
</Alert>

این راهنما بهت کمک می‌کنه تا اطلاعات، تنظیمات و اکانت‌های کاربری‌ت رو از مرزبان به پاسارگارد منتقل کنی، بدون اینکه چیزی از دست بره.

## پیش‌نیازها

> ⚠️ **مهم**: همیشه قبل از شروع فرآیند مهاجرت، یه بک‌آپ کامل از اطلاعاتت داشته باش.

- مطمئن شو که به سرورت دسترسی روت (root) داری.
- یه بک‌آپ از نصب فعلی مرزبان‌ت داشته باش.
- چک کن که Docker و Docker Compose نصب باشن.

## مراحل مهاجرت

### 1. سرویس‌های مرزبان رو متوقف کن

اول از همه، همه کانتینرهای در حال اجرای مرزبان رو متوقف کن:

#### دستورات توقف سرویس

```bash
cd /opt/marzban
docker compose down
```

### 2. اسم پوشه اصلی رو عوض کن

اسم پوشه اصلی مرزبان رو به PasarGuard تغییر بده:

#### دستور تغییر نام پوشه

```bash
sudo mv /opt/marzban /opt/pasarguard
```

### 3. اسم پوشه دیتا رو عوض کن

اسم پوشه دیتا رو هم تغییر بده:

#### دستور تغییر نام پوشه دیتا

```bash
sudo mv /var/lib/marzban /var/lib/pasarguard
```

### 4. اسم پوشه MySQL رو عوض کن (اگه استفاده می‌کنی)

اگه از MySQL استفاده می‌کنی و یه پوشه اختصاصی برای دیتابیس مرزبان داری:

#### دستور تغییر نام پوشه MySQL

```bash
sudo mv /var/lib/mysql/marzban /var/lib/mysql/pasarguard
```

### 5. متغیرهای محیطی رو به‌روز کن

برو به پوشه جدید PasarGuard و فایل محیطی رو به‌روز کن:

```bash
cd /opt/pasarguard
```

همه مسیرهای اشاره شده تو فایل `.env` رو با یه دستور ساده به‌روز کن:

```bash
sudo sed -i 's|/var/lib/marzban|/var/lib/pasarguard|g' .env
```

<Alert type="warning">
اگه از نسخه قدیمی (0.8.4 یا پایین‌تر) استفاده می‌کنی، باید درایور SQL رو هم تغییر بدی:
</Alert>

<Tabs items={['SQLite', 'MySQL']}>
  <Tab value="SQLite">
    ### به‌روزرسانی درایور SQLite

    ❌ قدیمی
    ```bash
    SQLALCHEMY_DATABASE_URL = "sqlite:///db.sqlite3"
    ```
    ✅ جدید
    ```bash
    SQLALCHEMY_DATABASE_URL = "sqlite+aiosqlite:///db.sqlite3"
    ```
  </Tab>
  <Tab value="MySQL">
    ### به‌روزرسانی درایور MySQL

    ❌ قدیمی
    ```bash
    SQLALCHEMY_DATABASE_URL = "mysql+pymysql://root:DB_PASSWORD@127.0.0.1/pasarguard"
    ```
    ✅ جدید
    ```bash
    SQLALCHEMY_DATABASE_URL = "mysql+asyncmy://root:DB_PASSWORD@127.0.0.1/pasarguard"
    ```
  </Tab>
</Tabs>

### 6. فایل Docker Compose رو به‌روز کن

فایل `docker-compose.yml` رو برای نشون دادن مسیرهای جدید به‌روز کن. باید این فایل رو دستی ویرایش کنی:

```bash
sudo nano docker-compose.yml
```

#### تغییرات Docker Compose

اینجا یه مقایسه هست که تغییرات لازم رو نشون می‌ده:

<div className="grid md:grid-cols-2 gap-4">

<div className="space-y-2">

**❌ قبل (مرزبان)**
```yaml
services:
  marzban:
    image: gozargah/marzban:latest
    restart: always
    env_file: .env
    network_mode: host
    volumes:
      - /var/lib/marzban:/var/lib/marzban
    depends_on:
      - mysql

  mysql:
    image: mysql:lts
    restart: always
    env_file: .env
    network_mode: host
    command: --bind-address=127.0.0.1 --mysqlx-bind-address=127.0.0.1 --disable-log-bin
    environment:
      MYSQL_DATABASE: marzban
    volumes:
      - /var/lib/mysql/marzban:/var/lib/mysql
```

</div>

<div className="space-y-2">

**✅ بعد (پاسارگارد)**
```yaml
services:
  pasarguard:
    image: pasarguard/panel:latest
    restart: always
    env_file: .env
    network_mode: host
    volumes:
      - /var/lib/pasarguard:/var/lib/pasarguard
    depends_on:
      - mysql

  mysql:
    image: mysql:lts
    restart: always
    env_file: .env
    network_mode: host
    command: --bind-address=127.0.0.1 --mysqlx-bind-address=127.0.0.1 --disable-log-bin
    environment:
      MYSQL_DATABASE: marzban
    volumes:
      - /var/lib/mysql/pasarguard:/var/lib/mysql
```

</div>

</div>

#### خلاصه تغییرات کلیدی:

<div className="overflow-x-auto">
<table>
<thead>
<tr>
<th>بخش</th>
<th>قبل</th>
<th>بعد</th>
</tr>
</thead>
<tbody>
<tr>
<td data-label="بخش"><strong>اسم سرویس</strong></td>
<td data-label="قبل"><code>marzban</code></td>
<td data-label="بعد"><code>pasarguard</code></td>
</tr>
<tr>
<td data-label="بخش"><strong>ایمیج داکر</strong></td>
<td data-label="قبل"><code>gozargah/marzban:latest</code></td>
<td data-label="بعد"><code>pasarguard/panel:latest</code></td>
</tr>
<tr>
<td data-label="بخش"><strong>حجم برنامه</strong></td>
<td data-label="قبل"><code>/var/lib/marzban:/var/lib/marzban</code></td>
<td data-label="بعد"><code>/var/lib/pasarguard:/var/lib/pasarguard</code></td>
</tr>
<tr>
<td data-label="بخش"><strong>حجم MySQL</strong></td>
<td data-label="قبل"><code>/var/lib/mysql/marzban:/var/lib/mysql</code></td>
<td data-label="بعد"><code>/var/lib/mysql/pasarguard:/var/lib/mysql</code></td>
</tr>
</tbody>
</table>
</div>

### 7. دسترسی‌های فایل رو به‌روز کن

مطمئن شو که دسترسی‌های لازم برای پوشه‌های جدید رو داری:

#### دستورات تنظیم دسترسی

```bash
sudo chown -R $USER:$USER /opt/pasarguard
sudo chmod -R 755 /opt/pasarguard
```

### 8. اسکریپت مدیریت پاسارگارد رو نصب کن

اسکریپت مدیریت پاسارگارد رو برای مدیریت راحت‌تر نصب کن:

#### دستور نصب اسکریپت

```bash
sudo bash -c "$(curl -sL https://github.com/PasarGuard/scripts/raw/main/pasarguard.sh)" @ install-script
```

این اسکریپت دستورات کاربردی برای مدیریت نصب پاسارگارد رو بهت می‌ده.

### 9. پاسارگارد رو راه‌اندازی کن

حالا پاسارگارد رو با تنظیمات جدید راه‌اندازی کن:

#### دستور راه‌اندازی

```bash
pasarguard up
```

### 10. مهاجرت رو بررسی کن

چک کن که همه سرویس‌ها درست کار می‌کنن:

#### دستورات بررسی

```bash
pasarguard status
```

آدرس پنل‌ت رو باز کن تا مطمئن شی همه چی اوکیه.

## عیب‌یابی

### مشکلات رایج

> 💡 **نکته**: بیشتر مشکلات با بررسی دسترسی‌های فایل و تنظیمات مسیرها حل می‌شن.

**1. اجازه دسترسی نداری (Permission Denied)**
مطمئن شو که دستورات رو با دسترسی‌های مناسب (sudo در صورت نیاز) اجرا می‌کنی.

**2. مشکلات اتصال به دیتابیس**
اگه از MySQL استفاده می‌کنی، چک کن که مسیرهای دیتابیس و اطلاعات ورود درست به‌روز شده باشن.

**3. تداخل پورت‌ها**
مطمئن شو که هیچ سرویس دیگه‌ای از پورت‌های مشابه استفاده نمی‌کنه.

**4. متغیرهای محیطی گم شده**
دوباره چک کن که همه متغیرهای محیطی تو فایل `.env` درست به‌روز شده باشن.

### برگشت به نسخه قبل (Rollback)

> ⚠️ **بازگشت اضطراری**: اگه با مشکلات جدی مواجه شدی و نیاز به بازگشت به نسخه قبل داری

```bash
# پاسارگارد رو متوقف کن
cd /opt/pasarguard
docker compose down

# پوشه‌های اصلی رو برگردون
sudo mv /opt/pasarguard /opt/marzban
sudo mv /var/lib/pasarguard /var/lib/marzban
sudo mv /var/lib/mysql/pasarguard /var/lib/mysql/marzban  # اگه استفاده می‌کنی

# فایل‌های docker-compose.yml و .env اصلی رو از بک‌آپ برگردون
# بعد مرزبان رو راه‌اندازی کن
marzban up
```

## بعد از مهاجرت

بعد از مهاجرت موفق:

- **📊 مانیتورینگ رو به‌روز کن**: اگه ابزارهای مانیتورینگ داری، اون‌ها رو به مسیرهای جدید متصل کن.
- **💾 بک‌آپ‌ها رو به‌روز کن**: مطمئن شو که اسکریپت‌های بک‌آپ‌ت برای بک‌آپ گرفتن از پوشه‌های جدید به‌روز شدن.
- **🧪 همه قابلیت‌ها رو تست کن**: همه قابلیت‌های پنل رو کامل تست کن تا مطمئن شی همه چی درست کار می‌کنه.

## پشتیبانی

🔗 **لینک‌ها**

- **گروه بحث و گفتگو**: [تلگرام](https://t.me/PasarGuardGP)
- **مشکلات**: اگه تو طول مهاجرت به مشکلی برخوردی، یه ایشو (issue) بساز.

---

> **📝 نکته**: این راهنما فرض رو بر این می‌ذاره که نصب مرزبان استاندارد بوده. تنظیمات شخصی ممکنه نیاز به مراحل اضافی داشته باشن.
