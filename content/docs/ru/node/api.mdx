---
title: Справочник API
description: Полный справочник REST API и gRPC для PasarGuard Node
icon: Code
---

## Обзор API

PasarGuard Node предоставляет интерфейсы **REST API** и **gRPC** для управления нодой, пользователями и получения статистики.

### Аутентификация

Все запросы к API требуют аутентификации с использованием `API_KEY`, настроенного в вашем файле `.env`.

**REST API:**
```http
Authorization: Bearer <api_key>
```

**gRPC:**
```
authorization: Bearer <api_key>
```

### Базовый URL

Запросы REST API должны отправляться на:
```
https://your-node-address:port/
```

### Тип содержимого

REST API использует Protocol Buffers для сериализации данных:
```http
Content-Type: application/x-protobuf
```

---

## Структуры данных

### Backend

```protobuf
message Backend {
  BackendType type;      // Тип бэкенда (XRAY = 0)
  string config;         // Конфигурация бэкенда
  repeated User users;   // Список пользователей
  uint64 keepAlive;      // Длительность keep alive в секундах
}
```

### User

```protobuf
message User {
  string email;           // Уникальный идентификатор email пользователя
  Proxy proxies;          // Конфигурации прокси
  repeated string inbounds; // Список тегов входящих соединений
}
```

### StatRequest

```protobuf
message StatRequest {
  string name;      // Email пользователя или тег входящего/исходящего соединения
  bool reset;       // Сбросить статистику трафика после получения
  StatType type;    // Тип статистики для получения
}

enum StatType {
  Outbounds = 0;   // Вся статистика исходящих соединений
  Outbound = 1;    // Статистика одного исходящего соединения
  Inbounds = 2;    // Вся статистика входящих соединений
  Inbound = 3;     // Статистика одного входящего соединения
  UsersStat = 4;   // Статистика всех пользователей
  UserStat = 5;    // Статистика одного пользователя
}
```

---

## Методы API

### Управление нодой

#### Запуск Backend

Запустите backend ноды с конфигурацией.

<Tabs items={['REST', 'gRPC']}>
  <Tab value="REST">
    ```http
    POST /start
    Authorization: Bearer <api_key>
    Content-Type: application/x-protobuf

    Body: Backend (protobuf)
    ```
  </Tab>
  <Tab value="gRPC">
    ```
    rpc Start(Backend) returns (BaseInfoResponse)
    ```
  </Tab>
</Tabs>

<Callout type="info">
  Это единственный метод, который вызывается перед созданием соединения с нодой.
</Callout>

---

#### Остановка Backend

Остановите backend и деактивируйте клиентские соединения.

<Tabs items={['REST', 'gRPC']}>
  <Tab value="REST">
    ```http
    PUT /stop
    Authorization: Bearer <api_key>
    ```
  </Tab>
  <Tab value="gRPC">
    ```
    rpc Stop(Empty) returns (Empty)
    ```
  </Tab>
</Tabs>

---

#### Получение базовой информации

Получите базовую информацию о ноде и проверьте статус соединения.

<Tabs items={['REST', 'gRPC']}>
  <Tab value="REST">
    ```http
    GET /info
    Authorization: Bearer <api_key>
    ```
  </Tab>
  <Tab value="gRPC">
    ```
    rpc GetBaseInfo(Empty) returns (BaseInfoResponse)
    ```
  </Tab>
</Tabs>

**Ответ:**
```protobuf
message BaseInfoResponse {
  string version;
  string core_type;
  bool running;
}
```

---

### Логирование

#### Получение логов

Потоковая передача логов backend в реальном времени.

<Tabs items={['REST', 'gRPC']}>
  <Tab value="REST">
    ```http
    GET /logs
    Authorization: Bearer <api_key>

    // Returns Server-Sent Events (SSE) stream
    ```
  </Tab>
  <Tab value="gRPC">
    ```
    rpc GetLogs(Empty) returns (stream Log)
    ```
  </Tab>
</Tabs>

**Структура лога:**
```protobuf
message Log {
  string detail;  // Log message
}
```

---

### Статистика

#### Получение системной статистики

Получите статистику на уровне системы.

<Tabs items={['REST', 'gRPC']}>
  <Tab value="REST">
    ```http
    GET /stats/system
    Authorization: Bearer <api_key>
    ```
  </Tab>
  <Tab value="gRPC">
    ```
    rpc GetSystemStats(Empty) returns (SystemStatsResponse)
    ```
  </Tab>
</Tabs>

**Ответ:**
```protobuf
message SystemStatsResponse {
  uint64 mem_total;                  // Total memory
  uint64 mem_used;                   // Used memory
  uint64 cpu_cores;                  // CPU cores
  double cpu_usage;                  // CPU usage %
  uint64 incoming_bandwidth_speed;   // Download speed
  uint64 outgoing_bandwidth_speed;   // Upload speed
}
```

---

#### Получение статистики Backend

Получите статистику работы backend.

<Tabs items={['REST', 'gRPC']}>
  <Tab value="REST">
    ```http
    GET /stats/backend
    Authorization: Bearer <api_key>
    ```
  </Tab>
  <Tab value="gRPC">
    ```
    rpc GetBackendStats(Empty) returns (BackendStatsResponse)
    ```
  </Tab>
</Tabs>

**Ответ:**
```protobuf
message BackendStatsResponse {
  uint32 num_goroutine;    // Active goroutines
  uint32 num_gc;           // GC runs
  uint64 alloc;            // Allocated memory
  uint64 total_alloc;      // Total allocated
  uint64 sys;              // System memory
  uint64 mallocs;          // Malloc count
  uint64 frees;            // Free count
  uint64 live_objects;     // Live objects
  uint64 pause_total_ns;   // Total GC pause
  uint32 uptime;           // Uptime in seconds
}
```

---

#### Получение статистики трафика

Получите статистику трафика для пользователей, inbound или outbound.

<Tabs items={['REST', 'gRPC']}>
  <Tab value="REST">
    ```http
    GET /stats
    Authorization: Bearer <api_key>
    Content-Type: application/x-protobuf

    Body: StatRequest (protobuf)
    ```
  </Tab>
  <Tab value="gRPC">
    ```
    rpc GetStats(StatRequest) returns (StatResponse)
    ```
  </Tab>
</Tabs>

**Примеры:**

Получить статистику всех пользователей:
```protobuf
StatRequest {
  type: UsersStat,
  reset: false
}
```

Получить статистику конкретного пользователя:
```protobuf
StatRequest {
  name: "user@example.com",
  type: UserStat,
  reset: true  // Reset after retrieval
}
```

**Ответ:**
```protobuf
message StatResponse {
  repeated Stat stats;
}

message Stat {
  string name;   // User email or tag
  string type;   // Stat type
  string link;   // Link identifier
  int64 value;   // Traffic value in bytes
}
```

---

#### Получение онлайн-статистики пользователя

Получите количество активных соединений пользователя.

<Tabs items={['REST', 'gRPC']}>
  <Tab value="REST">
    ```http
    GET /stats/user/online
    Authorization: Bearer <api_key>
    Content-Type: application/x-protobuf

    Body: StatRequest (protobuf)
    ```
  </Tab>
  <Tab value="gRPC">
    ```
    rpc GetUserOnlineStats(StatRequest) returns (OnlineStatResponse)
    ```
  </Tab>
</Tabs>

**Ответ:**
```protobuf
message OnlineStatResponse {
  string name;   // User email
  int64 value;   // Online connection count
}
```

---

#### Получение списка IP-адресов онлайн пользователя

Получите список IP-адресов активных соединений пользователя.

<Tabs items={['REST', 'gRPC']}>
  <Tab value="REST">
    ```http
    GET /stats/user/online_ip
    Authorization: Bearer <api_key>
    Content-Type: application/x-protobuf

    Body: StatRequest (protobuf)
    ```
  </Tab>
  <Tab value="gRPC">
    ```
    rpc GetUserOnlineIpListStats(StatRequest) returns (StatsOnlineIpListResponse)
    ```
  </Tab>
</Tabs>

---

### Управление пользователями

#### Синхронизация пользователя

Добавьте, обновите или удалите одного пользователя.

<Tabs items={['REST', 'gRPC']}>
  <Tab value="REST">
    ```http
    PUT /user/sync
    Authorization: Bearer <api_key>
    Content-Type: application/x-protobuf

    Body: User (protobuf)
    ```
  </Tab>
  <Tab value="gRPC">
    ```
    rpc SyncUser(stream User) returns (Empty)
    ```
  </Tab>
</Tabs>

<Callout type="info">
  Чтобы **удалить** пользователя, отправьте пустой массив inbounds. gRPC предоставляет потоковый интерфейс, но REST требует отдельных вызовов для каждого пользователя.
</Callout>

---

#### Синхронизация пользователей

Замените всех пользователей новым набором.

<Tabs items={['REST', 'gRPC']}>
  <Tab value="REST">
    ```http
    PUT /users/sync
    Authorization: Bearer <api_key>
    Content-Type: application/x-protobuf

    Body: Users (protobuf)
    ```
  </Tab>
  <Tab value="gRPC">
    ```
    rpc SyncUsers(Users) returns (Empty)
    ```
  </Tab>
</Tabs>

<Callout type="warn">
  Этот метод **удаляет всех старых пользователей** и заменяет их предоставленным списком.
</Callout>

---

## Ответы об ошибках

### HTTP коды статуса

| Код | Значение |
|------|---------|
| 200 | Успешно |
| 400 | Неверный запрос - недопустимые данные |
| 401 | Неавторизован - недействительный API_KEY |
| 404 | Не найдено - endpoint не существует |
| 500 | Внутренняя ошибка сервера |

### Формат ошибки

```json
{
  "error": "Error description",
  "code": "ERROR_CODE"
}
```

---

## Ограничение скорости

В настоящее время нет встроенных ограничений скорости, но рекомендуется:
- Группировать обновления пользователей, когда это возможно
- Кешировать статистику локально
- Избегать чрезмерного опроса

